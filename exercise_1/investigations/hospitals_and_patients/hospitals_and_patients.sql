select ((avg(meanScore*starRating)-avg(meanScore)*avg(starRating)) / (stddev(meanScore)*stddev(starRating))) as meanHospital_starRating_cor, ((avg(varScore*starRating)-avg(varScore)*avg(starRating)) / (stddev(varScore)*stddev(starRating))) as varHospital_starRating_cor from(Select hospital_general_s.Provider_ID,  sum(Score*Sample)/sum(Sample) as meanScore,   pow(stddev(Score),2) as varScore from (Select Provider_ID, avg( if(`Measure_Name`="Percent of newborns whose deliveries were scheduled early (1-3 weeks early), when a scheduled delivery was not medically necessary",100-Score,Score) ) as Score, Measure_Name, sum(Sample) as Sample from effective_hospital_s where Measure_Name in ("Discharge instructions","Healthcare workers given influenza vaccination","Immunization for influenza","Percent of newborns whose deliveries were scheduled early (1-3 weeks early), when a scheduled delivery was not medically necessary","Prophylactic Antibiotic Initiated Within One Hour Prior to Surgical Incision","Prophylactic antibiotic received within 1 hour prior to surgical incision","Prophylactic Antibiotic Selection for Surgical Patients","Prophylactic antibiotics discontinued within 24 hours after surgery end time") group by Provider_ID,Measure_Name) as cleanSet inner join hospital_general_s on cleanSet.Provider_ID = hospital_general_s.Provider_ID group by hospital_general_s.Provider_ID) as hospitals inner join  (select Provider_ID,(sum(Patient_Survey_Star_Rating* if(Number_of_Completed_Surveys = 'Between 100 and 299',150,300)) / sum(if(Number_of_Completed_Surveys = 'Between 100 and 299',150,300))) as starRating from survey_hospital_s where Patient_Survey_Star_Rating in (0,1,2,3,4,5) group by Provider_ID ) as patients on hospitals.Provider_ID = patients.Provider_ID
